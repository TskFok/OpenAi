<table xmlns="http://www.w3.org/1999/html">
    <script src="public/static/jquery.js"></script>
    <script src="public/static/markdown/editormd.min.js"></script>
    <link rel="stylesheet" href="public/static/markdown/css/editormd.css"/>
    <body>
    <div id="question"><textarea id="question-area"></textarea></div>
    <br>
    <div style="height: 30px"><span id="msg">等待中</span></div>
    <br>
    key: <input type="text" id="key" placeholder="请输入你的key">
    <br>
    <br>
    <input type="button" onclick="tStream()" value="提问">
    <br>
    <br>
    <a href="/chat-web-sse">sse</a>&nbsp;&nbsp;&nbsp;
    <a href="/chat-web-ws">ws</a>&nbsp;&nbsp;&nbsp;
    <a href="/image">image</a>
    </body>
</table>
<script type="text/javascript">
    var editor
    $(function () {
        editor = editormd("question", {
            theme: "dark",
            previewTheme: "dark",
            editorTheme: "ambiance",
            width: "100%",
            height: "500",
            path: "public/static/markdown/lib/",
            syncScrolling: "single",
            saveHTMLToTextarea: true,
            placeholder: "输入你的问题"
        });
    });

    var rand = Math.round(Math.random() * 100000 + 100000);

    var ws = new WebSocket("wss://chat.dolayy.com/ws/gpt-file/chat-" + rand);
    //申请一个WebSocket对象，参数是服务端地址，同http协议使用http://开头一样，WebSocket协议的url使用ws://开头，另外安全的WebSocket协议使用wss://开头
    ws.onopen = function () {
        //当WebSocket创建成功时，触发onopen事件
        console.log("open");
    }
    ws.onmessage = function (e) {
        if (e.data == "<<stop>>") {
            document.getElementById("msg").innerHTML = "已完成"
        } else {
            document.getElementById("msg").innerHTML = "返回中"
            editor.setMarkdown(editor.getMarkdown() + e.data)
        }
    }
    ws.onclose = function (e) {
        //当客户端收到服务端发送的关闭连接请求时，触发onclose事件
        console.log("close");
    }
    ws.onerror = function (e) {
        //如果出现连接、处理、接收、发送数据失败的时候触发onerror事件
        console.log(e);
    }

    function tStream() {
        let question = editor.getMarkdown()

        if (question === undefined || question === "") {
            alert("请输入提问")

            return
        }

        let key = document.getElementById("key").value;
        if (key === undefined || key === "") {
            alert("请输入key")

            return
        }

        let ret = {
            "question": question,
            "key": key
        }

        editor.setMarkdown("")

        document.getElementById("msg").innerHTML = "开始请求"

        ws.send(JSON.stringify(ret))
    }

</script>